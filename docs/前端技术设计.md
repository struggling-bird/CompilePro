# CompilePro 前端技术设计（React）

## 总览
- 目标：提供围绕“git源—模板—项目—编译”的高效、可审计的前端工作台。
- 技术栈：React 18、建议 TypeScript、构建推荐 Vite；路由 React Router；状态管理建议 Redux Toolkit 或 Zustand；UI 组件库建议 Ant Design；HTTP 客户端 Axios；表单校验建议 Zod/Yup；实时日志统一使用 WebSocket。
- 设计原则：模块化、可观察、表单驱动、权限受控、强校验、可预览。

## 路由与页面
- `/login` 登录页：账号/密码登录，失败提示；登录成功跳转首页。
- `/sources` git源列表：列表、搜索过滤、新建、编辑、添加版本、禁用。
- `/sources/:id` git源编辑：仓库信息、分支/Tag、凭证、可暴露配置项定义；连通性测试。
- `/templates` 模板列表：展示模板名、类型、源数量、状态；新建/编辑入口。
- `/templates/:id` 模板编辑：勾选 git源及版本策略、聚合配置项、冲突消解、编译顺序与依赖。
- `/configs` 配置实例列表：模板/项目维度的配置快照；新建/编辑/复制；校验状态展示。
- `/configs/new` 新建配置：按模板生成表单；支持导入 JSON；校验与预览。
- `/builds` 编译任务：触发编译、任务列表、状态、日志流、产物下载、回滚入口。
- `/settings` 设置：全局参数、凭证管理、用户与权限、审计规则。

## 目录结构建议
- `src/app` 应用入口与全局提供者（Store、Router、Theme、i18n）。
- `src/pages` 路由页面目录（login、sources、templates、configs、builds、settings）。
- `src/components` 通用组件（表格、表单、步骤条、日志视图、Diff 预览）。
- `src/features` 领域组件与逻辑（auth、gitSource、template、configInstance、build、credential）。
- `src/services` API 客户端与协议适配（axios 实例、拦截器、error 归一化）。
- `src/store` 状态管理（slices 或 zustand stores）。
- `src/routes` 路由声明与守卫。
- `src/utils` 工具库（校验、格式化、权限判定、下载器）。
- `src/assets` 静态资源。
- `src/types` 领域类型与 DTO。

## 状态管理
- `authSlice`：`user`、`roles`、`tokenMeta`、登录/登出/刷新。
- `gitSourcesSlice`：列表、详情、版本列表、创建/更新/禁用、连通性状态。
- `templatesSlice`：列表、详情、源绑定、版本策略、依赖、聚合配置草案。
- `configsSlice`：配置实例列表、当前编辑配置、校验结果、快照哈希。
- `buildsSlice`：任务列表、当前任务状态、实时日志、产物信息。
- `settingsSlice`：全局参数、凭证列表、用户与权限映射、审计策略。
- `uiSlice`：全局加载、通知、对话框、主题。

## API 客户端
- Axios 基础实例：
  - 请求拦截：附加 `Authorization` 头（Access Token）；请求 ID；幂等键。
  - 响应拦截：错误归一化（`{code,message,details}`）；401 触发刷新或跳转登录。
- 错误策略：
  - 用户可恢复错误以通知提示；不可恢复错误以对话框提示并记录审计。
  - 支持重试策略（如网络抖动）；禁止对非幂等写操作自动重试。
- WebSocket：
  - 连接：`ws://<host>/ws` 或 `wss://<host>/ws`，通过 Query 参数 `token` 或受控 Cookie 携带令牌。
  - 订阅：发送 `{type:"subscribe", buildId}`，接收 `{type:"log", buildId, ts, level, stage, line, cursor}`、`{type:"error", code, message}`、`{type:"end", buildId}`。
  - 心跳与重连：`ping/pong` 心跳；指数退避重连；支持断点续订（携带 `cursor`）。
  - 过滤与导出：前端对日志进行关键字过滤与导出文件。

## 表单与校验
- JSON 配置项：
  - 基于 schema 驱动的表单生成；支持类型（string/number/bool/array/object）。
  - 校验规则：必填、枚举、长度、范围、自定义正则；错误集中展示与字段级提示。
- 文件替换：
  - 字段：源路径、目标路径、覆盖策略（覆盖/追加/跳过）、模板变量。
  - 预览：渲染后 Diff 视图；冲突提示与排序调整。
- 文本替换：
  - 字段：目标文件、匹配规则（占位符/正则）、变量来源。
  - 预览：差异高亮；批量应用与回滚。

## 权限与路由守卫
- 认证态：登录后保存 Access Token 元信息；推荐使用内存持有 + 刷新令牌 HttpOnly Cookie。
- 角色与资源：基于 `roles` 与资源操作（读/写/执行）进行按钮级与路由级授权。
- 守卫策略：
  - 未登录访问受限路由重定向 `/login`。
  - 权限不足显示 `403` 页面或禁用操作。

## 视图组件
- 列表表格：分页、筛选、排序、批量操作、行内操作。
- 编辑表单：分组、步骤条、草稿保存、校验即时反馈。
- 日志视图：基于 WebSocket 的流式加载、阶段跳转、关键字过滤、导出；断线重连与断点续订。
- Diff 预览：Monaco 编辑器差异视图或轻量 Diff 组件。
- 产物卡片：名称、版本、哈希、下载、发布记录、回滚。

## 性能与体验
- 代码分割：按路由与大型组件分割；懒加载与占位骨架。
- 请求缓存：对列表页与详情页使用 SWR/RTK Query 或手动缓存。
- 并发优化：批量请求合并；节流防抖。
- 可用性：操作幂等提示；重复提交防护；进度反馈。

## 国际化与可访问性
- i18n：react-i18next，中文为默认；文案抽离 JSON。
- 可访问性：表单标签、键盘导航、色彩对比。

## 安全
- XSS 防护：输出转义、富文本禁用或白名单。
- CSRF：若使用 Cookie，结合后端 CSRF Token 验证；推荐使用双令牌模式。
- 存储安全：敏感信息不入 localStorage；使用内存与受控 Cookie。

## 配置与环境
- 环境变量：`VITE_API_BASE_URL`、`VITE_WS_URL`、`VITE_BUILD_ENV`。
- 构建：Vite 配置别名、代理；生产开启 gzip 与资源哈希。

## 测试与质量
- 单元测试：组件与工具；覆盖关键逻辑（校验、权限、API 适配）。
- 端到端：Playwright 覆盖核心流程（登录、创建源、创建模板、新建配置、触发编译、查看日志）。
- 静态检查：ESLint + Prettier；TypeScript 严格模式。

## 部署与运维
- 构建产物：静态文件通过 CDN/静态托管；与后端同域或启用 CORS。
- 监控：前端埋点（性能、错误、交互）；可视化报表。

## 接口契约（摘要）
- Auth：`POST /auth/login`、`POST /auth/refresh`、`POST /auth/logout`。
- GitSource：`GET/POST/PATCH/DELETE /git-sources`、`POST /git-sources/:id/versions`、`GET /git-sources/:id/versions`、`POST /git-sources/:id/test`。
- Template：`GET/POST/PATCH/DELETE /templates`、`POST /templates/:id/sources`。
- ConfigInstance：`GET/POST/PATCH/DELETE /configs`、`POST /configs/:id/validate`。
- Build：`POST /builds`、`GET /builds`、`GET /builds/:id`、`WS /ws`（订阅 `{type: "subscribe", buildId}`，接收日志事件）、`POST /builds/:id/retry`、`POST /builds/:id/rollback`。
- Settings/Credential：`GET/POST/PATCH/DELETE /settings`、`GET/POST/PATCH/DELETE /credentials`。
