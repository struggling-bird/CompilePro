# CompilePro 项目计划

## 背景与目标
- 背景：现有多项目编译部署分散、配置理解门槛高、版本管理混乱，缺乏统一入口与审计。
- 总目标：构建围绕“git源—模板—项目—编译”的统一平台，降低运维门槛，规范版本管理，提供实时可观测与可回滚能力。
- 明确要求：
  - 前端基于 React；实时日志统一使用 WebSocket。
  - 后端基于 Node.js；支持自动生成接口文档（OpenAPI，选配 AsyncAPI）。

## 范围与交付物
- 产品层：git源管理、模板管理、配置实例、编译任务、设置/凭证、审计与权限。
- 技术层：
  - 前端工作台（React 18 + TS + Vite + Router + 状态管理 + AntD）。
  - 后端服务（Node.js + TS，建议 NestJS/Express + Prisma + PostgreSQL + Redis + BullMQ + MinIO/S3）。
  - WebSocket 实时日志通道（`/ws` 握手与订阅协议）。
  - 接口文档生成与发布（`/docs`、`/openapi.json`；可选 `/asyncapi.yaml`）。
  - CI/CD 管线与基础监控（健康、队列、任务指标）。
- 交付物清单：
  - 设计文档：产品、前端、后端、项目计划。
  - 源码与基础脚手架：前端与后端最小可运行结构。
  - 数据库迁移脚本与初始化数据（最小角色与权限）。
  - 文档生成脚本与可视化页面（Swagger UI）。
  - 部署说明与环境变量清单。

## 里程碑
- M1 设计冻结：完成产品/技术设计与项目计划；评审通过。
- M2 架构搭建：后端基础服务与数据库、队列、对象存储接入；前端项目初始化与路由骨架。
- M3 领域实现 A：git源/模板/配置实例核心 CRUD 与校验；OpenAPI 初版可用。
- M4 编译与日志：Worker 队列、替换引擎、产物上传；WebSocket 通道接入与日志流渲染。
- M5 权限与审计：RBAC、凭证管理、审计事件；安全与限流策略。
- M6 测试与优化：单元/集成/E2E 覆盖；性能与稳定性优化；监控与告警。
- M7 发布与文档：上线发布、回滚预案；文档完备（API/事件/部署）。

## 工作分解（WBS）
- 需求与设计
  - 明确场景与角色、权限矩阵；冻结产品与技术方案。
- 后端架构
  - 项目骨架、配置加载、日志框架、错误规范、健康检查。
  - 数据库 schema（`git_sources`、`source_versions`、`templates`、`template_sources`、`projects`、`config_instances`、`builds`、`credentials`、`audits`）。
  - Prisma 集成与迁移；基础仓储与服务层。
- REST 接口
  - Auth、GitSource、Template、Project、ConfigInstance、Build、Settings、Credential、Audit 控制器与服务。
  - OpenAPI 生成与路由分组、示例与错误模型；`/docs` 与 `/openapi.json`。
- 编译执行
  - BullMQ 队列；Worker 步骤：拉取→替换→构建→打包→产出→校验。
  - 替换引擎（文件/文本；Handlebars/Mustache）、变量命名空间与冲突检查。
  - 产物上传 MinIO/S3；日志结构化与归档。
- WebSocket 通道
  - 握手 JWT 校验；订阅/取消订阅协议；心跳与断线重连。
  - Redis Pub/Sub 推送；断点续传与流控；指标与审计。
  - （可选）AsyncAPI 文档生成与发布。
- 前端实现
  - 项目初始化（Vite/TS/Router/状态/AntD）；全局提供者与权限守卫。
  - 页面：登录、git源、模板、配置、编译、设置；表单校验与预览。
  - API 客户端（Axios 拦截）、错误治理；WebSocket 客户端与日志视图。
- 安全与合规
  - RBAC、最小权限、凭证密文管理；速率限制与来源白名单。
  - 输入校验、路径与命令注入防护；CORS 与 Cookie 策略。
- 运维与发布
  - 环境变量清单；容器化与部署脚本；备份与灾备。
  - 监控指标与告警；运行手册与回滚预案。
- 测试与质量
  - 单元：服务与仓储、替换引擎、校验器。
  - 集成：REST/WS 端到端；权限与审计覆盖。
  - E2E：关键用户流程（登录→新建源→模板→配置→编译→查看日志）。
  - 压测：队列并发、WS 连接与消息速率；资源占用与降级策略。

## 时间与资源（建议）
- 团队构成：后端 2、前端 2、测试 1、运维 1（可兼岗）。
- 周期建议：8–10 周（视团队与范围微调）。
  - 设计 1 周、架构 1 周、核心领域 2–3 周、编译与日志 2 周、权限与审计 1 周、测试与优化 1–2 周、上线与文档 1 周。

## 质量与验收标准
- 功能完成度：核心模块与页面均按规格可用；编译任务可成功与失败路径可见。
- 文档完备：`/docs` 与 `/openapi.json` 可访问；（可选）`/asyncapi.yaml` 可访问；部署与运维文档齐备。
- 安全与权限：RBAC 生效；敏感信息不泄露；速率限制与来源控制生效。
- 可观测性：健康、队列、任务、WS 指标可用；告警规则触发有效。
- 可靠性：幂等保存与触发；回滚功能可用；故障可恢复。
- 性能基线：
  - 1000 并发 WS 连接稳定；消息延迟 P95 < 500ms（内网场景）。
  - 队列吞吐满足日常编译并发需求；日志归档与产物上传无阻塞。

## 风险与应对
- 版本策略复杂与依赖循环：严格拓扑排序与策略固化；拒绝循环依赖并报错。
- 替换冲突与误替换：预检与预览、覆盖策略显式；差异可视化与回滚。
- 资源瓶颈：队列与 WS 流控、降采样；水平扩展与指标监控。
- 安全风险：令牌泄露、注入与路径穿越；最小权限与严格校验，审计与限流。

## 变更与发布管理
- 需求变更流程：评审、影响分析、计划更新与版本标记。
- 发布策略：灰度与回滚点；数据库迁移与兼容检查；产物版本化与签名。

## 沟通与协作机制
- 周会同步里程碑与风险；每日站会追踪任务状态。
- 代码评审与规范统一（ESLint/Prettier/Commit 规范）。
- 文档更新策略：设计与接口文档与代码变更同步。

## 依赖与前置条件
- 基础设施：PostgreSQL、Redis、对象存储（MinIO/S3）、CI/CD 环境。
- 凭证与安全：Git/制品库/云凭证准备；密钥管理策略确认。
- 域名与证书：后端服务与 WS 支持 HTTPS/WSS；CORS 与来源白名单设定。

## 交付验收
- 文档与源码齐备；环境可部署；关键流程可演示（含异常路径）。
- 指标面板与审计查询可用；安全扫描通过；压测报告达标。

