# CompilePro 产品设计文档

## 产品概述
- 目标：统一编译部署入口，提炼公共配置，降低运维理解门槛，规范版本管理，让每次编译部署都有据可查。
- 核心思路：围绕“git源—模板—项目”三层抽象组织配置与编译。
- 适用场景：私有部署（标准/单机）、线上 SaaS、测试环境等不同部署类型，均以模板复用与项目实例化落地。

## 核心概念
- git源：单个 Git 仓库的抽象；平台提取需暴露的配置项并管理可编译的版本。
- 模板：由多个 git源组成的部署方案，面向部署类型并复用配置。
- 项目：选择指定模板，以客户/环境为单位实例化部署，一个客户的一次部署即一个项目。

## 信息架构
- 登录：进入平台的认证入口（参考 prd/1. 登录.png）。
- git源列表与编辑：管理仓库与其可暴露配置（参考 prd/2. git源.png、prd/3. git源编辑.png）。
- 源版本管理：登记/锁定可编译的源码版本（参考 prd/3.1 添加源版本.png）。
- 配置项管理：
  - JSON 配置（参考 prd/3.2 json配置项.png）：结构化键值参数。
  - 文件替换（参考 prd/3.3  文件替换.png）：按路径替换文件模板。
  - 文本替换（参考 prd/3.4 文本替换.png）：对文本模板进行变量替换。
- 模板列表与编辑：聚合 git源形成部署模板（参考 prd/4 模板列表.png、prd/5 新建_编辑模板.png）。
- 配置列表与新建：针对模板/项目的具体配置实例（参考 prd/6 配置列表.png、prd/7 新建配置.png）。
- 编译：触发编译、查看日志与产物（参考 prd/8 编译.png）。
- 设置：平台全局参数与凭证管理（参考 prd/9 设置.png）。

## 角色与权限
- 管理员：全域管理 git源、模板、项目、设置与用户。
- 运维工程师：管理模板与项目，执行编译与查看产物。
- 只读审计：查看版本、配置、编译历史与日志。
- 权限原则：按资源（源/模板/项目）与操作（读/写/执行）细分授权；编译触发需具备执行权限。

## 功能规格
### 登录
- 支持用户名密码或企业单点；失败提示与锁定策略；成功后进入首页。

### git源
- 列表：名称、仓库地址、默认分支、维护者、状态、更新时间。
- 新建/编辑：仓库 URL、分支/Tag 选择策略、认证凭证选择、可暴露配置项定义。
- 版本：添加版本时记录来源（Tag/Commit）、摘要、变更说明，支持状态位（可用/弃用）。

### 配置项
- JSON：键、类型（string/number/bool/array/object）、默认值、校验（必填/枚举/长度/范围）、提示文案。
- 文件替换：源路径/目标路径、模板引擎变量、覆盖策略（覆盖/追加/跳过）。
- 文本替换：目标文件、匹配规则（占位符/正则，支持分组捕获与替换）、变量来源、变更预览。

### 模板
- 列表：模板名、部署类型、包含 git源数、最近更新、状态。
- 编辑：选源与其版本锁定策略（固定Tag/最新稳定/按规则），配置项聚合与冲突解决（命名空间/别名），编译顺序与依赖。

### 配置实例
- 列表：绑定模板/项目、环境（prod/staging/dev）、版本指针、创建者、更新时间。
- 新建：选择模板与环境，填写/导入配置，校验并保存为可编译配置快照。

### 编译
- 触发：选项目/配置实例，确认 git源版本锁定，设置编译参数（并发/缓存/容器镜像）。
- 过程：实时日志、阶段（拉取—替换—构建—打包—产出—校验）、错误定位。
- 产物：名称、版本、摘要、哈希、下载地址、发布记录、回滚点。

### 设置
- 全局：默认分支策略、版本命名规范、制品存储目标、日志保留。
- 凭证：Git 凭证、制品库凭证、容器/云凭证，密文存储与轮换。
- 用户与权限：角色分配、资源授权、审计规则。

## 流程设计
### 新建 git源
- 填仓库信息 → 校验可达 → 定义可暴露配置（JSON/文件/文本） → 保存 → 登记首个可用版本。

### 维护源版本
- 选择源 → 添加版本（Tag/Commit） → 填写变更描述 → 设置可用状态与兼容范围。

### 创建模板
- 新建模板 → 选入多个 git源 → 为每个源设定版本锁定策略 → 聚合配置项 → 配置冲突消解 → 保存。

### 新建配置实例
- 选择模板与环境 → 填写/导入参数 → 校验 → 生成快照 → 标记可编译。

### 执行编译
- 选择项目与配置快照 → 确定源版本 → 执行 → 查看日志 → 生成产物 → 归档与校验 → 通知。

### 变更与回滚
- 变更配置或源版本 → 触发新编译 → 若异常，选历史产物或配置快照回滚。

## 数据模型（逻辑）
- GitSource：`id`、`name`、`repo_url`、`default_branch`、`credential_ref`、`exposed_config_schema`、`created_at`、`updated_at`。
- SourceVersion：`id`、`git_source_id`、`tag_or_commit`、`summary`、`changelog`、`usable`、`created_at`。
- Template：`id`、`name`、`deploy_type`、`description`、`created_at`、`updated_at`。
- TemplateSource：`id`、`template_id`、`git_source_id`、`version_strategy`（fixed/latest/stable-rule）、`build_order`、`dependency`。
- Project：`id`、`name`、`customer`、`environment`、`template_id`、`owner`、`created_at`。
- ConfigInstance：`id`、`template_id`、`project_id`、`env`、`config_json`、`file_replacements`、`text_replacements`、`validated`、`snapshot_hash`、`created_at`。
- Build：`id`、`project_id`、`config_snapshot_hash`、`resolved_versions`、`status`（running/success/fail）、`logs_ref`、`artifact_ref`、`created_at`、`finished_at`。
- Credential：`id`、`type`（git/artifact/cloud）、`secret_ref`、`scope`、`rotated_at`。

## 版本管理策略
- 源版本：以 Tag 或 Commit 记录；可用/弃用状态；变更说明与兼容注记，支持按模板锁定固定版本或策略版本。
- 模板稳定性：模板版本可选（若需要），或以模板配置更新时间为基准；编译时始终固化“源版本 + 配置快照”。

## 配置与替换机制
- 变量来源：模板聚合的 JSON 配置为主，文件/文本替换共享同一变量命名空间并支持命名空间前缀。
- 校验：保存配置实例前进行类型/必填/范围校验；编译前进行文件路径/覆盖策略冲突检查。
- 可视化预览：文本/文件替换提供差异与渲染预览，以减少误替换风险。

## 编译与产物管理
- 任务编排：按模板定义的构建顺序和依赖执行；步骤失败时中止并记录错误上下文。
- 日志：分阶段存储，支持过滤与下载；长任务提供心跳与重试策略。
- 产物：带版本与哈希；存储在制品库；可关联发布目标与回滚点。

## 设置与安全
- 凭证管理：以凭证引用方式绑定到源/制品/云组件；密文不落盘；定期轮换提醒。
- 访问控制：资源级与操作级权限；编译触发、配置编辑需最小权限。
- 审计：记录关键操作（登录、源/模板/配置/编译），支持按人/资源/时间检索。

## 非功能需求
- 可用性：核心操作（保存配置、触发编译）需幂等；失败可重试。
- 性能：并发拉取与编译队列；日志流式输出；大仓库拉取缓存。
- 可观测性：健康检查、队列长度、任务耗时、成功率与失败原因指标。
- 备份：配置与编译产物元数据定期备份；灾备恢复流程。

## 页面说明
- 登录：账号、密码、登录按钮、错误提示；成功跳转首页。
- git源列表：新建、编辑、添加版本、禁用；搜索与过滤（按名称/维护者/状态）。
- git源编辑：仓库 URL、默认分支、凭证、暴露配置项定义；测试连接与拉取权限校验。
- 添加源版本：Tag/Commit、摘要与变更说明、可用状态；保存后出现在版本选择面板。
- JSON配置项：键名、类型、默认值、校验规则；校验结果与错误提示。
- 文件替换：源文件/目标文件；模板变量；覆盖策略；替换预览。
- 文本替换：占位符/正则；变量来源；差异预览与批量应用。
- 模板列表/新建编辑：选择 git源及其版本策略；构建顺序与依赖；配置项聚合与冲突解决。
- 配置列表/新建：针对模板/项目创建具体配置实例；校验通过后生成快照。
- 编译：实时日志、阶段状态；成功后产物与下载；失败后错误定位与重试。
- 设置：全局参数与凭证管理、用户与权限；审计策略配置。

## 交互与校验
- 必填校验：关键字段（仓库 URL、模板名、项目名、配置项必填）未填禁止保存。
- 预检：编译前检查源版本解析、配置快照完整性、替换路径冲突。
- 幂等保障：重复提交保存/编译请求以快照哈希去重。
- 变更确认：对高风险操作（覆盖文件、删除配置）进行二次确认与日志记录。

## 风险与边界
- 仓库访问失败：在源编辑阶段进行连通性与权限预检，编译时重试有限次。
- 替换冲突：同一目标文件的多替换规则需显式排序或报错提示。
- 版本漂移：模板使用“最新稳定”策略需在编译时固化实际解析版本并记录。

