# CompilePro 后端技术设计（Node.js）

## 总览
- 目标：提供安全、可观察、可扩展的编译管理后端服务，支撑“git源—模板—项目—编译”全流程。
- 技术栈建议：Node.js 20、TypeScript；Web 框架建议 NestJS 或 Express；数据库建议 PostgreSQL（或 MySQL）；ORM 建议 Prisma；队列与缓存使用 Redis；任务队列建议 BullMQ；对象存储建议 MinIO/S3；日志 pino；校验 Joi/Zod。
- 风格原则：领域模块化、幂等、强校验、可回滚、审计全覆盖。

## 系统架构
- 网关层（HTTP/S）：REST API + WebSocket；统一认证与速率限制。
- 业务层（Service/Domain）：Auth、GitSource、SourceVersion、Template、Project、ConfigInstance、Build、Credential、Settings、Audit。
- 编译执行层（Worker）：消费队列，执行拉取、替换、构建、打包、产出、校验；流式日志；产物上传。
- 存储层：
  - 关系型数据库：元数据与配置快照。
  - Redis：队列、短期缓存、幂等键、分布式锁。
  - 对象存储：编译产物与日志归档。

## 模块划分
- Auth 模块：登录、刷新、登出；JWT；RBAC；审计。
- GitSource 模块：仓库注册、连通性测试、可暴露配置项 schema 管理；版本登记。
- Template 模块：模板 CRUD；源绑定与版本策略；依赖与编译顺序。
- Project 模块：项目 CRUD；与模板绑定；环境配置。
- ConfigInstance 模块：配置实例 CRUD；校验与快照生成；冲突检查。
- Build 模块：任务触发、状态管理、日志流、产物管理、回滚。
- Credential 模块：凭证密文绑定与轮换；最小暴露策略。
- Settings 模块：全局参数、规则配置。
- Audit 模块：操作与事件审计。

## 数据库设计（摘要）
- `users`：`id`、`username`、`password_hash`、`roles`、`created_at`。
- `git_sources`：`id`、`name`、`repo_url`、`default_branch`、`credential_id`、`exposed_schema_json`、`created_at`、`updated_at`。
- `source_versions`：`id`、`git_source_id`、`tag_or_commit`、`summary`、`changelog`、`usable`、`created_at`。
- `templates`：`id`、`name`、`deploy_type`、`description`、`created_at`、`updated_at`。
- `template_sources`：`id`、`template_id`、`git_source_id`、`version_strategy`、`build_order`、`dependency_json`。
- `projects`：`id`、`name`、`customer`、`environment`、`template_id`、`owner_id`、`created_at`。
- `config_instances`：`id`、`template_id`、`project_id`、`env`、`config_json`、`file_replacements_json`、`text_replacements_json`、`validated`、`snapshot_hash`、`created_at`。
- `builds`：`id`、`project_id`、`config_snapshot_hash`、`resolved_versions_json`、`status`、`logs_ref`、`artifact_ref`、`created_at`、`finished_at`。
- `credentials`：`id`、`type`、`secret_ref`、`scope`、`rotated_at`。
- `audits`：`id`、`actor_id`、`action`、`resource_type`、`resource_id`、`details_json`、`created_at`。

## 接口设计（REST/WS）
- Auth
  - `POST /auth/login`：用户名密码登录；返回 accessToken 与 refreshToken（刷新令牌建议 HttpOnly Cookie）。
  - `POST /auth/refresh`：刷新 accessToken。
  - `POST /auth/logout`：注销并失效刷新令牌。
- GitSource
  - `GET /git-sources`、`POST /git-sources`、`GET /git-sources/:id`、`PATCH /git-sources/:id`、`DELETE /git-sources/:id`。
  - `POST /git-sources/:id/test`：连通性/权限测试。
  - `GET /git-sources/:id/versions`、`POST /git-sources/:id/versions`。
- Template
  - `GET /templates`、`POST /templates`、`GET /templates/:id`、`PATCH /templates/:id`、`DELETE /templates/:id`。
  - `POST /templates/:id/sources`：绑定/更新源与版本策略。
- Project
  - `GET /projects`、`POST /projects`、`GET /projects/:id`、`PATCH /projects/:id`、`DELETE /projects/:id`。
- ConfigInstance
  - `GET /configs`、`POST /configs`、`GET /configs/:id`、`PATCH /configs/:id`、`DELETE /configs/:id`。
  - `POST /configs/:id/validate`：类型与范围校验，返回错误明细与快照哈希。
- Build
  - `POST /builds`：触发编译；返回任务 ID。
  - `GET /builds`、`GET /builds/:id`：查询任务与状态。
  - `WS /ws`：WebSocket 日志与进度流，客户端发送 `{type:"subscribe", buildId}` 订阅，服务端推送 `{type:"log", buildId, ts, level, stage, line, cursor}`、`{type:"end", buildId}`、错误事件。
  - `POST /builds/:id/retry`：失败重试；`POST /builds/:id/rollback`：回滚到历史产物或配置快照。
- Settings/Credential
  - `GET/POST/PATCH/DELETE /settings`；`GET/POST/PATCH/DELETE /credentials`。
- Audit
  - `GET /audits`：按人/资源/时间过滤审计记录。

## 认证与授权
- 认证：JWT（RS256）；Access Token 短时；Refresh Token 长时。
- 存储建议：刷新令牌使用 HttpOnly、Secure Cookie；Access Token 由前端持有于内存。
- 授权：RBAC + 资源操作（读/写/执行）；路由与业务双重检查。
- 审计：登录、源/模板/配置/编译的所有写操作记录到 `audits`。
 - WebSocket：握手阶段校验 JWT（Query `token` 或受控 Cookie）；来源白名单；连接、订阅、取消订阅与异常断开写审计。

## 校验与错误处理
- 输入校验：Joi/Zod DTO 层校验；文件/文本替换路径冲突预检。
- 错误规范：`{code, message, details, traceId}`；幂等冲突返回 409；权限不足 403；验证失败 422。
- 幂等：对保存与触发编译提供快照哈希去重；使用 Redis 幂等键 + TTL。

## Git 与版本解析
- 拉取策略：浅克隆（`--depth 1`）；缓存本地镜像；分支/Tag/Commit 锁定。
- 并发控制：同一源并发拉取使用分布式锁；失败重试退避。
- 配置提取：按 `exposed_schema_json` 解析与校验；不落地敏感信息。

## 模板与依赖
- 版本策略：固定 Tag、最新稳定、规则匹配；实际编译时固化解析版本入快照。
- 编译顺序：拓扑排序执行；循环依赖拒绝并记录错误。

## 编译执行（Worker）
- 队列：BullMQ；任务状态（queued/running/success/fail）；最大并发与速率限制。
- 步骤：拉取 → 替换（文件/文本） → 构建 → 打包 → 产出 → 校验。
- 替换引擎：模板引擎（Handlebars/Mustache）；变量命名空间与前缀支持。
- 日志：分阶段、结构化（pino）；通过 Redis Pub/Sub 推送至 WebSocket 层；归档到对象存储。
- 产物：生成哈希与清单；上传到 MinIO/S3；返回 `artifact_ref`。

## 存储与缓存
- 数据库：Prisma 管理 schema 与迁移；事务封装写操作；外键约束与索引优化。
- Redis：队列、缓存、分布式锁（Redlock）；短期配置缓存与版本解析缓存。
- 对象存储：分桶管理产物与日志；生命周期与清理策略。

## 配置与密钥
- 配置源：环境变量 + 配置文件；集中配置服务可选。
- 密钥管理：使用 KMS/Secrets Manager 或本地安全存储；绝不日志输出密文。

## 监控与可观测性
- 健康检查：`GET /health`（DB/Redis/对象存储/队列）。
- 指标：任务耗时、成功率、失败原因、队列长度、拉取耗时、构建耗时。
- 追踪：OpenTelemetry（可选）；traceId 贯穿。
 - WebSocket 指标：连接数、订阅数、消息速率、丢包率、重连次数。

## 安全
- 速率限制与防爆破：登录与敏感接口限流；IP 黑白名单策略（可选）。
- CORS：严格来源白名单；SSE/WebSocket 跨域配置。
- 上传/下载：产物下载鉴权与防盗链；日志下载权限控制。
- 输入输出：严格 DTO 校验与输出最小化；避免路径穿越与命令注入。
 - WebSocket：消息大小限制、每连接速率限制、订阅权限校验、断点续传光标校验。

## WebSocket 服务设计
- 握手与连接：`/ws` 路径，JWT 校验通过后建立连接；失败返回错误并关闭。
- 订阅协议：
  - 订阅：`{type:"subscribe", buildId}`；取消：`{type:"unsubscribe", buildId}`。
  - 消息：`{type:"log", buildId, ts, level, stage, line, cursor}`；结束：`{type:"end", buildId}`；错误：`{type:"error", code, message}`；心跳：`ping/pong`。
- 扩展与横向扩展：多实例使用 Redis Pub/Sub 或 Socket 适配器；分布式锁保障同一 build 的推送顺序与唯一性。
- 断点续传：客户端携带 `cursor` 请求续推；服务端维护短期缓存或持久化片段，回放至最新位置。
- 流控与稳定性：消息速率与队列长度阈值，超限降采样或丢弃并告警；连接级限流与熔断。

## 接口文档生成
- OpenAPI（REST）：
  - NestJS：集成 `@nestjs/swagger`，自动从控制器与 DTO 生成；暴露 `GET /docs`（Swagger UI）与 `GET /openapi.json`。
  - Express：使用 `swagger-jsdoc` 与 `swagger-ui-express`；注释驱动生成；暴露同样接口。
  - 安全：声明 `BearerAuth`；全局响应模型与错误规范；示例与枚举。
  - 版本：`info.version` 与服务版本保持一致；路由分组按模块分类（Sources/Templates/Builds 等）。
- AsyncAPI（WebSocket）：
  - 描述 `/ws` 通道与事件消息 schema（`subscribe`, `log`, `end`, `error`, `ping/pong`）。
  - 提供 `GET /asyncapi.yaml`（可选）与 UI；在 CI 中校验与事件模型一致性。
- 生成与校验：
  - 脚本：`npm run docs:openapi` 输出 JSON/YAML；`npm run docs:asyncapi`（可选）。
  - CI 校验：路由扫描与文档一致性检查；阻止接口漂移；对 breaking change 发出警报。

## 部署与运维
- 进程模型：API 与 Worker 分离部署；水平扩展；Redis 与数据库高可用。
- CI/CD：安装依赖 → 代码检查 → 单元测试 → 构建 → 数据库迁移 → 部署。
- 备份与灾备：数据库定期备份；对象存储版本化；异地容灾（可选）。

## 测试策略
- 单元测试：服务与仓储层；Git 拉取、替换引擎、校验器。
- 集成测试：API 端到端（Auth、源/模板/配置/编译）。
- 负载与稳定性：编译队列压力测试；并发冲突与锁机制验证。

## 迁移与演进
- Schema 版本化与向后兼容；配置项新增采用默认值策略。
- 模块扩展：支持更多 SCM（如 GitLab API）、更多构建器（Docker/Kaniko）。
